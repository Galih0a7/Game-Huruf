<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Alphabet Challenge - 60s</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #0f172a; color: white; text-align: center; margin: 0; padding: 0; }
        .stats { display: flex; justify-content: space-around; background: #1e293b; padding: 15px; width: 100%; box-sizing: border-box; font-weight: bold; font-size: 1.2rem; border-bottom: 3px solid #3b82f6; }
        #menu-screen { padding: 50px 20px; }
        #game-screen { display: none; padding: 10px; }
        #target-letter { font-size: 120px; font-weight: bold; color: #fbbf24; margin: 5px 0; text-shadow: 0 0 20px rgba(251, 191, 36, 0.4); }
        #webcam-container { position: relative; margin: 10px auto; border: 4px solid #334155; border-radius: 15px; overflow: hidden; width: 300px; height: 300px; background: #000; }
        canvas { width: 100% !important; height: auto !important; }
        button { padding: 15px 30px; font-size: 18px; margin: 10px; border-radius: 50px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:active { transform: scale(0.95); }
        .btn-single { background: #4ade80; color: #064e3b; width: 80%; max-width: 300px; }
        .btn-duo { background: #94a3b8; color: #1e293b; width: 80%; max-width: 300px; cursor: not-allowed; opacity: 0.6; }
        .btn-pass { background: #ef4444; color: white; width: 150px; }
        #message { height: 30px; margin: 10px; font-size: 1.2rem; font-weight: bold; color: #4ade80; }
        h1 { color: #3b82f6; letter-spacing: 2px; }
    </style>
</head>
<body>

<div id="menu-screen">
    <h1>AI POSE GAME</h1>
    <p style="color: #94a3b8;">Bentuk huruf T, Y, atau I dengan tubuhmu!</p>
    <button class="btn-single" onclick="selectMode('single')">MULAI (60 DETIK)</button>
    <br>
    <button class="btn-duo" disabled>MODE DUO (SEGERA)</button>
</div>

<div id="game-screen">
    <div class="stats">
        <div>‚è±Ô∏è <span id="timer">60</span>s</div>
        <div>üèÜ <span id="score">0</span></div>
    </div>
    
    <div style="margin-top: 10px; color: #94a3b8; text-transform: uppercase;" id="mode-display"></div>
    <div id="target-letter">?</div>
    
    <div id="webcam-container"></div>
    <div id="message">Memuat AI...</div>
    
    <button class="btn-pass" onclick="passLetter()">SKIP (PASS)</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@latest/dist/teachablemachine-pose.min.js"></script>

<script>
    const URL = "./"; 
    let model, webcam, ctx, gameMode;
    let score = 0, timeLeft = 60, isPlaying = false; // Durasi 60 detik
    
    const singleLetters = ["S_T", "S_Y", "S_I"]; 
    let currentLetter = "";

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(freq) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.frequency.value = freq;
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.5);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.5);
    }

    async function selectMode(mode) {
        gameMode = mode;
        document.getElementById("menu-screen").style.display = "none";
        document.getElementById("game-screen").style.display = "block";
        await init();
    }

    async function init() {
        const modelURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";

        try {
            model = await posenet.load(modelURL, metadataURL);
            webcam = new tmPose.Webcam(300, 300, false); 
            await webcam.setup({ facingMode: "environment" }); // Kamera belakang
            await webcam.play();
            
            const canvas = document.createElement("canvas");
            canvas.width = 300; canvas.height = 300;
            ctx = canvas.getContext("2d");
            document.getElementById("webcam-container").appendChild(canvas);
            
            window.requestAnimationFrame(loop);
            startGame();
        } catch (e) {
            document.getElementById("message").innerHTML = "Error loading model!";
        }
    }

    function startGame() {
        score = 0;
        timeLeft = 60; // Timer mulai dari 60
        isPlaying = true;
        document.getElementById("mode-display").innerHTML = "Mode: Individual";
        nextLetter();
        
        const countdown = setInterval(() => {
            if(!isPlaying) { clearInterval(countdown); return; }
            timeLeft--;
            document.getElementById("timer").innerHTML = timeLeft;
            if (timeLeft <= 0) {
                clearInterval(countdown);
                isPlaying = false;
                alert("WAKTU HABIS!\nSkor Akhir: " + score);
                location.reload();
            }
        }, 1000);
    }

    function nextLetter() {
        const randomIndex = Math.floor(Math.random() * singleLetters.length);
        currentLetter = singleLetters[randomIndex];
        document.getElementById("target-letter").innerHTML = currentLetter.split("_")[1];
        document.getElementById("message").innerHTML = "Ayo bentuk posenya!";
    }

    function passLetter() {
        if (isPlaying) {
            playSound(300);
            nextLetter();
        }
    }

    async function loop() {
        webcam.update();
        await predict();
        window.requestAnimationFrame(loop);
    }

    async function predict() {
        const { pose, posenetOutput } = await model.estimatePose(webcam.canvas);
        const prediction = await model.predict(posenetOutput);

        if (isPlaying) {
            for (let i = 0; i < prediction.length; i++) {
                if (prediction[i].className === currentLetter && prediction[i].probability > 0.85) {
                    score += 10;
                    document.getElementById("score").innerHTML = score;
                    document.getElementById("message").innerHTML = "MANTAP! +10";
                    playSound(880); 
                    nextLetter();
                }
            }
        }
        drawPose(pose);
    }

    function drawPose(pose) {
        if (webcam.canvas) {
            ctx.drawImage(webcam.canvas, 0, 0);
            if (pose) {
                tmPose.drawKeypoints(pose.keypoints, 0.5, ctx);
                tmPose.drawSkeleton(pose.keypoints, 0.5, ctx);
            }
        }
    }
</script>
</body>
</html>
